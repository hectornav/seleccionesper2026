{% extends 'candidatos/base.html' %}
{% load static %}

{% block title %}Intenci√≥n de Voto ‚Äî Elecciones Per√∫ 2026{% endblock %}

{% block content %}
<section style="background:linear-gradient(135deg,var(--dark),#16213e);padding:2rem 0;color:white">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item"><a href="{% url 'candidatos:home' %}">Inicio</a></li>
                <li class="breadcrumb-item active">Intenci√≥n de Voto</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-3 mb-2">
            <div style="font-size:2rem">üìä</div>
            <div>
                <h1 style="font-size:1.8rem;font-weight:800;margin:0">Intenci√≥n de Voto</h1>
                <p style="color:rgba(255,255,255,0.7);margin:0;font-size:0.9rem">Simulaci√≥n en tiempo real de los votos
                    en la plataforma</p>
            </div>
        </div>
    </div>
</section>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div style="background:white;border-radius:16px;padding:2rem;box-shadow:var(--card-shadow);">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 style="font-weight:800;font-size:1.4rem;color:var(--dark);margin:0">Resultados Generales</h2>
                    <span id="total-votos"
                        style="font-size:0.85rem;font-weight:600;color:var(--text-muted-custom)"><span
                            class="spinner-border spinner-border-sm text-danger" role="status"></span>
                        Calculando...</span>
                </div>

                <div id="resultados-container">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border text-danger" style="width: 2.5rem; height: 2.5rem;" role="status">
                        </div>
                        <p class="mt-3">Cargando resultados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadResultados() {
        fetch('/votacion/api/resultados/')
            .then(res => res.json())
            .then(data => {
                document.getElementById('total-votos').textContent = `${data.total_votos} Votos registrados`;

                const container = document.getElementById('resultados-container');
                container.innerHTML = '';

                if (data.resultados.length === 0) {
                    container.innerHTML = '<div class="text-center py-5 text-muted"><p style="font-size: 1.1rem; margin-bottom: 0;">A√∫n no hay votos registrados.</p><p style="font-size: 0.9rem;">S√© el primero en votar desde la p√°gina principal.</p></div>';
                    return;
                }

                data.resultados.forEach((r, idx) => {
                    const isTop = idx === 0;
                    const el = document.createElement('div');
                    el.className = 'resultado-card mb-3';
                    el.style.border = isTop ? '2px solid var(--gold)' : '2px solid transparent';
                    el.style.background = isTop ? 'linear-gradient(135deg, #fff 80%, var(--gold-light) 100%)' : '#fff';
                    el.style.padding = '1.2rem';
                    el.style.borderRadius = '12px';
                    el.style.boxShadow = 'var(--card-shadow)';
                    el.style.animation = `fadeInUp 0.4s ease ${idx * 0.1}s both`;

                    el.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            ${isTop ? '<span style="font-size: 1.3rem;">ü•á</span>' : `<span style="font-size: 0.85rem; font-weight: 700; color: #888; width: 24px;">${idx + 1}.</span>`}
                            <span style="font-weight: 800; color: var(--dark); font-size: 1.05rem;">${r.nombre}</span>
                            <span class="badge" style="background-color: ${r.color || 'var(--dark)'}; font-size: 0.7rem;">${r.partido}</span>
                        </div>
                        <div class="text-end">
                            <span style="font-weight: 800; font-size: 1.2rem; color: ${isTop ? 'var(--gold)' : 'var(--peru-red)'};">${r.porcentaje}%</span>
                            <div style="font-size: 0.75rem; color: var(--text-muted-custom); margin-top: -3px;">${r.votos} votos</div>
                        </div>
                    </div>
                    
                    <div class="progress mt-2" style="height: 10px; border-radius: 5px; background-color: #f1f3f5;">
                        <div class="progress-bar ${isTop ? 'progress-bar-striped progress-bar-animated bg-warning' : 'bg-danger'}" 
                             role="progressbar" 
                             style="width: 0%; transition: width 1.5s ease; ${isTop ? '' : 'background: linear-gradient(to right, var(--peru-red), #ff4d4d) !important;'}" 
                             aria-valuenow="${r.porcentaje}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                `;
                    container.appendChild(el);

                    // Animate progress bar after short delay
                    setTimeout(() => {
                        const bar = el.querySelector('.progress-bar');
                        if (bar) bar.style.width = `${r.porcentaje}%`;
                    }, 100);
                });
            })
            .catch(err => {
                console.error('Error cargando resultados:', err);
                document.getElementById('resultados-container').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Error al cargar los resultados de intenci√≥n de voto. Int√©ntalo m√°s tarde.
                </div>`;
            });
    }

    document.addEventListener('DOMContentLoaded', loadResultados);
</script>
{% endblock %}